# Build stage
FROM node:20-alpine AS builder

WORKDIR /app

# Install pnpm
RUN corepack enable && corepack prepare pnpm@9.15.0 --activate

# Copy package files
COPY package.json pnpm-workspace.yaml pnpm-lock.yaml* ./
COPY packages/entities/package.json ./packages/entities/
COPY packages/shared/package.json ./packages/shared/
COPY apps/pkg-core/package.json ./apps/pkg-core/

# Install dependencies
RUN pnpm install --frozen-lockfile || pnpm install

# Copy source
COPY tsconfig.base.json ./
COPY packages ./packages
COPY apps/pkg-core ./apps/pkg-core

# Build packages and app
RUN pnpm --filter @pkg/entities build
RUN pnpm --filter @pkg/shared build
RUN pnpm --filter @pkg/pkg-core build

# Production stage
FROM node:20-alpine AS production

WORKDIR /app

# Install pnpm, Claude CLI, and su-exec for user switching
RUN corepack enable && corepack prepare pnpm@9.15.0 --activate && \
    npm install -g @anthropic-ai/claude-code && \
    apk add --no-cache su-exec

# Copy package files
COPY package.json pnpm-workspace.yaml ./
COPY packages/entities/package.json ./packages/entities/
COPY packages/shared/package.json ./packages/shared/
COPY apps/pkg-core/package.json ./apps/pkg-core/

# Install production dependencies only
RUN pnpm install --prod --frozen-lockfile || pnpm install --prod

# Copy built files
COPY --from=builder /app/packages/entities/dist ./packages/entities/dist
COPY --from=builder /app/packages/shared/dist ./packages/shared/dist
COPY --from=builder /app/apps/pkg-core/dist ./apps/pkg-core/dist

# Copy claude-workspace for agents and CLAUDE.md
COPY claude-workspace ./claude-workspace

# Copy entrypoint script
COPY docker/entrypoint-pkg-core.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Create non-root user with home directory for Claude credentials
# Entrypoint runs as root to copy credentials, then switches to nestjs via su-exec
RUN addgroup -g 1001 -S nodejs && \
    adduser -S nestjs -u 1001 -G nodejs -h /home/nestjs && \
    mkdir -p /home/nestjs/.claude && \
    chown -R nestjs:nodejs /home/nestjs

# Set Claude workspace path
ENV CLAUDE_WORKSPACE_PATH=/app/claude-workspace

EXPOSE 3000

ENTRYPOINT ["/entrypoint.sh"]
