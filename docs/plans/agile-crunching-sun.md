# –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏: Smart Fact Fusion

## –û–±–∑–æ—Ä

–ó–∞–º–µ–Ω–∞ –ø—Ä–æ—Å—Ç–æ–≥–æ skip-–¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ –Ω–∞ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–µ —Å–ª–∏—è–Ω–∏–µ —Ñ–∞–∫—Ç–æ–≤ —á–µ—Ä–µ–∑ LLM —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏ –æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞—Ö.

**–ü—Ä–æ–±–ª–µ–º–∞:** –¢–µ–∫—É—â–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–æ—Å—Ç–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Ö–æ–∂–∏–µ —Ñ–∞–∫—Ç—ã, —Ç–µ—Ä—è—è —Ü–µ–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é:
```
"–†–∞–±–æ—Ç–∞–µ—Ç –≤ –°–±–µ—Ä–µ" + "–í–µ–¥—É—â–∏–π —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –≤ –°–±–µ—Ä–±–∞–Ω–∫–µ"
‚Üí –¢–µ–∫—É—â–µ–µ: SKIP (–ø–æ—Ç–µ—Ä—è–ª–∏ –¥–æ–ª–∂–Ω–æ—Å—Ç—å!)
‚Üí –¶–µ–ª—å: ENRICH ‚Üí "–í–µ–¥—É—â–∏–π —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –≤ –°–±–µ—Ä–±–∞–Ω–∫–µ"
```

**–†–µ—à–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**
1. UI –¥–ª—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ ‚Äî Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ‚úÖ
2. LLM —Ä–µ—à–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ ‚úÖ
3. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: MANUAL > EXTRACTED > IMPORTED ‚úÖ

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     SMART FACT FUSION FLOW                       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                  ‚îÇ
‚îÇ  New Fact ‚îÄ‚Üí Generate Embedding ‚îÄ‚Üí Find Similar (>0.85)         ‚îÇ
‚îÇ                                           ‚îÇ                      ‚îÇ
‚îÇ                                           ‚ñº                      ‚îÇ
‚îÇ                                  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îÇ
‚îÇ                                  ‚îÇ  LLM Decision  ‚îÇ              ‚îÇ
‚îÇ                                  ‚îÇ    Service     ‚îÇ              ‚îÇ
‚îÇ                                  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îÇ
‚îÇ                                          ‚îÇ                       ‚îÇ
‚îÇ         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                 ‚îÇ
‚îÇ         ‚ñº        ‚ñº        ‚ñº      ‚ñº            ‚ñº                 ‚îÇ
‚îÇ     CONFIRM   ENRICH  SUPERSEDE COEXIST   CONFLICT              ‚îÇ
‚îÇ         ‚îÇ        ‚îÇ        ‚îÇ      ‚îÇ            ‚îÇ                 ‚îÇ
‚îÇ         ‚ñº        ‚ñº        ‚ñº      ‚ñº            ‚ñº                 ‚îÇ
‚îÇ     +conf    merge     deprec  keep both   Telegram             ‚îÇ
‚îÇ              value     old                 notification         ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## –§–∞–∑—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### Phase 1: –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö

**–§–∞–π–ª—ã:**
- `packages/entities/src/entity-fact.entity.ts` (MODIFY)
- `apps/pkg-core/src/database/migrations/XXXXXX-AddFactFusionFields.ts` (NEW)

**–ù–æ–≤—ã–µ –ø–æ–ª—è EntityFact:**

```typescript
// Ranking (Wikidata-style)
@Column({ type: 'varchar', length: 20, default: 'normal' })
rank: 'preferred' | 'normal' | 'deprecated';

// Fact linking
@Column({ name: 'superseded_by', type: 'uuid', nullable: true })
supersededById: string | null;

@ManyToOne(() => EntityFact, { nullable: true })
@JoinColumn({ name: 'superseded_by' })
supersededBy: EntityFact | null;

// Conflict tracking
@Column({ name: 'needs_review', type: 'boolean', default: false })
needsReview: boolean;

@Column({ name: 'review_reason', type: 'text', nullable: true })
reviewReason: string | null;

// Confirmation tracking
@Column({ name: 'confirmation_count', type: 'integer', default: 1 })
confirmationCount: number;
```

**–ú–∏–≥—Ä–∞—Ü–∏—è:**
```sql
ALTER TABLE entity_facts ADD COLUMN rank VARCHAR(20) DEFAULT 'normal';
ALTER TABLE entity_facts ADD COLUMN superseded_by UUID REFERENCES entity_facts(id);
ALTER TABLE entity_facts ADD COLUMN needs_review BOOLEAN DEFAULT FALSE;
ALTER TABLE entity_facts ADD COLUMN review_reason TEXT;
ALTER TABLE entity_facts ADD COLUMN confirmation_count INTEGER DEFAULT 1;

CREATE INDEX idx_entity_facts_rank ON entity_facts(entity_id, fact_type, rank);
CREATE INDEX idx_entity_facts_needs_review ON entity_facts(id) WHERE needs_review = TRUE;
```

**Acceptance:**
- [x] –ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- [x] –ò–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞–Ω—ã
- [x] Entity –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞

---

### Phase 2: FactFusionService (LLM Decision)

**–§–∞–π–ª—ã:**
- `apps/pkg-core/src/modules/entity/entity-fact/fact-fusion.service.ts` (NEW)
- `apps/pkg-core/src/modules/entity/entity-fact/fact-fusion.constants.ts` (NEW)

**JSON Schema –¥–ª—è LLM:**
```typescript
const FUSION_DECISION_SCHEMA = {
  type: 'object',
  properties: {
    action: {
      type: 'string',
      enum: ['confirm', 'enrich', 'supersede', 'coexist', 'conflict'],
      description: 'Decision type'
    },
    mergedValue: {
      type: 'string',
      nullable: true,
      description: 'Merged value for enrich action'
    },
    explanation: {
      type: 'string',
      description: 'Why this decision was made (Russian)'
    },
    confidence: {
      type: 'number',
      minimum: 0,
      maximum: 1,
      description: 'Confidence in decision'
    }
  },
  required: ['action', 'explanation', 'confidence']
};
```

**–°–µ—Ä–≤–∏—Å:**
```typescript
@Injectable()
export class FactFusionService {
  constructor(
    private claudeAgentService: ClaudeAgentService,
    @InjectRepository(EntityFact)
    private factRepo: Repository<EntityFact>,
  ) {}

  async decideFusion(
    existingFact: EntityFact,
    newFactValue: string,
    newFactSource: FactSource,
    context?: { messageContent?: string },
  ): Promise<FusionDecision> {
    const prompt = this.buildPrompt(existingFact, newFactValue, newFactSource, context);

    const { data } = await this.claudeAgentService.call<FusionDecision>({
      mode: 'oneshot',
      taskType: 'fact_fusion',
      prompt,
      schema: FUSION_DECISION_SCHEMA,
      model: 'haiku',  // Fast + cheap for decisions
      timeout: 30000,
    });

    return data;
  }

  async applyDecision(
    existingFact: EntityFact,
    newFactDto: CreateFactDto,
    decision: FusionDecision,
  ): Promise<CreateFactResult> {
    switch (decision.action) {
      case 'confirm':
        return this.handleConfirm(existingFact);
      case 'enrich':
        return this.handleEnrich(existingFact, decision.mergedValue!);
      case 'supersede':
        return this.handleSupersede(existingFact, newFactDto);
      case 'coexist':
        return this.handleCoexist(existingFact, newFactDto);
      case 'conflict':
        return this.handleConflict(existingFact, newFactDto, decision.explanation);
    }
  }
}
```

**Prompt template:**
```
Analyze two facts about the same person/organization:

EXISTING FACT:
- Type: ${existingFact.factType}
- Value: "${existingFact.value}"
- Source: ${existingFact.source} (priority: ${SOURCE_PRIORITY[existingFact.source]})
- Confidence: ${existingFact.confidence}
- Created: ${existingFact.createdAt}

NEW FACT:
- Type: ${newFactDto.type}
- Value: "${newFactDto.value}"
- Source: ${newFactDto.source} (priority: ${SOURCE_PRIORITY[newFactDto.source]})
${context?.messageContent ? `- Context: "${context.messageContent.slice(0, 200)}"` : ''}

SOURCE PRIORITY: MANUAL(100) > EXTRACTED(70) > IMPORTED(50)

Determine relationship:

1. CONFIRM - Same information, just confirmation
   Example: "–†–∞–±–æ—Ç–∞–µ—Ç –≤ –°–±–µ—Ä–µ" ‚âà "–†–∞–±–æ—Ç–∞–µ—Ç –≤ –°–±–µ—Ä–±–∞–Ω–∫–µ"
   ‚Üí Increase confidence of existing

2. ENRICH - Complementary, can merge into richer fact
   Example: "–í –°–±–µ—Ä–µ" + "–í–µ–¥—É—â–∏–π —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –≤ –°–±–µ—Ä–±–∞–Ω–∫–µ"
   ‚Üí Merge: "–í–µ–¥—É—â–∏–π —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –≤ –°–±–µ—Ä–±–∞–Ω–∫–µ"

3. SUPERSEDE - New is more specific/accurate
   Example: "–î–† –≤ –º–∞—Ä—Ç–µ" ‚Üí "–î–† 15.03.1990"
   ‚Üí Deprecate old, use new

4. COEXIST - Different time periods or both valid
   Example: "CTO –≤ 2020" + "CEO –≤ 2024"
   ‚Üí Keep both with temporal markers

5. CONFLICT - Contradictory, needs human review
   Example: "–†–∞–±–æ—Ç–∞–µ—Ç –≤ –°–±–µ—Ä–µ" + "–†–∞–±–æ—Ç–∞–µ—Ç –≤ –¢–∏–Ω—å–∫–æ—Ñ—Ñ" (same time)
   ‚Üí Flag for user resolution

Return JSON with action, mergedValue (if enrich), explanation (Russian), confidence.
```

**Acceptance:**
- [x] LLM –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø —Ä–µ—à–µ–Ω–∏—è
- [x] "–†–∞–±–æ—Ç–∞–µ—Ç –≤ –°–±–µ—Ä–µ" + "—Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –°–±–µ—Ä–±–∞–Ω–∫–µ –†–æ—Å—Å–∏–∏" ‚Üí CONFIRM (verified)
- [ ] "–î–† –≤ –º–∞—Ä—Ç–µ" + "–î–† 15.03.1990" ‚Üí SUPERSEDE (not tested)
- [x] –ü—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è ‚Üí CONFLICT ("–°—Ç–∞—Ä—à–∏–π —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫" vs "–í–µ–¥—É—â–∏–π —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫" ‚Üí needs_review=true)

---

### Phase 3: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ EntityFactService

**–§–∞–π–ª—ã:**
- `apps/pkg-core/src/modules/entity/entity-fact/entity-fact.service.ts` (MODIFY)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ createWithDedup():**

```typescript
async createWithDedup(
  entityId: string,
  dto: CreateFactDto,
  options?: {
    skipSemanticCheck?: boolean;
    skipFusion?: boolean;  // NEW: –¥–ª—è —Ç–µ—Å—Ç–æ–≤
    messageContext?: string;  // NEW: –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
  },
): Promise<CreateFactResult> {
  // 1. Check for semantic duplicates
  if (dto.value && this.embeddingService && !options?.skipSemanticCheck) {
    const dupResult = await this.checkSemanticDuplicate(entityId, dto.value, dto.type);

    if (dupResult.isDuplicate && dupResult.existingFact) {
      // 2. NEW: Use LLM to decide fusion strategy
      if (!options?.skipFusion && this.factFusionService) {
        const decision = await this.factFusionService.decideFusion(
          dupResult.existingFact,
          dto.value,
          dto.source || FactSource.EXTRACTED,
          { messageContent: options?.messageContext },
        );

        this.logger.log(
          `Fusion decision for "${dto.value}": ${decision.action} (${decision.confidence})`
        );

        return this.factFusionService.applyDecision(
          dupResult.existingFact,
          dto,
          decision,
        );
      }

      // Fallback: simple skip (backward compatible)
      return {
        fact: dupResult.existingFact,
        action: 'skipped',
        reason: dupResult.reason,
        existingFactId: dupResult.existingFact.id,
      };
    }
  }

  // ... rest of creation logic
}
```

**Acceptance:**
- [ ] Backward compatible (skipFusion —Ä–∞–±–æ—Ç–∞–µ—Ç)
- [ ] LLM –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –¥—É–±–ª–∏–∫–∞—Ç–∞
- [ ] –í—Å–µ —Ç–∏–ø—ã —Ä–µ—à–µ–Ω–∏–π –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

### Phase 4: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞—Ö (Telegram)

**–§–∞–π–ª—ã:**
- `apps/pkg-core/src/modules/notification/fact-conflict.service.ts` (NEW)
- `apps/pkg-core/src/modules/notification/notification.module.ts` (MODIFY)
- `apps/telegram-adapter/src/bot/handlers/fact-callback.handler.ts` (NEW)

**–§–æ—Ä–º–∞—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:**
```
‚ö†Ô∏è <b>–ö–æ–Ω—Ñ–ª–∏–∫—Ç —Ñ–∞–∫—Ç–æ–≤</b>

üë§ –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤
üìã –¢–∏–ø: position

<b>–°—É—â–µ—Å—Ç–≤—É—é—â–∏–π:</b>
"–†–∞–±–æ—Ç–∞–µ—Ç –≤ –°–±–µ—Ä–±–∞–Ω–∫–µ"
üìÖ –î–æ–±–∞–≤–ª–µ–Ω: 15.01.2025

<b>–ù–æ–≤—ã–π:</b>
"–†–∞–±–æ—Ç–∞–µ—Ç –≤ –¢–∏–Ω—å–∫–æ—Ñ—Ñ"
üìÖ –ò–∑–≤–ª–µ—á—ë–Ω: 20.01.2025
üí¨ <a href="tg://...">–ò–∑ —Å–æ–æ–±—â–µ–Ω–∏—è</a>

–ö–∞–∫–æ–π —Ñ–∞–∫—Ç –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω?

[‚úÖ –ù–æ–≤—ã–π] [‚ùå –°—Ç–∞—Ä—ã–π] [üîÄ –û–±–∞ –≤–µ—Ä–Ω—ã]
```

**Callback format:**
```
fact_new:<shortId>   ‚Üí –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π, deprecated —Å—Ç–∞—Ä—ã–π
fact_old:<shortId>   ‚Üí –û—Å—Ç–∞–≤–∏—Ç—å —Å—Ç–∞—Ä—ã–π, –æ—Ç–∫–ª–æ–Ω–∏—Ç—å –Ω–æ–≤—ã–π
fact_both:<shortId>  ‚Üí –°–æ–∑–¥–∞—Ç—å –æ–±–∞ –∫–∞–∫ coexist
```

**FactConflictService:**
```typescript
@Injectable()
export class FactConflictService {
  constructor(
    private telegramNotifier: TelegramNotifierService,
    private digestActionStore: DigestActionStoreService,
    @InjectRepository(EntityFact)
    private factRepo: Repository<EntityFact>,
  ) {}

  async notifyConflict(
    existingFact: EntityFact,
    newFactData: CreateFactDto,
    entityName: string,
    sourceMessageLink?: string,
  ): Promise<string> {
    // Store both fact IDs for callback resolution
    const shortId = await this.digestActionStore.store([
      existingFact.id,
      JSON.stringify(newFactData),  // New fact not saved yet
    ]);

    const message = this.formatConflictMessage(
      existingFact,
      newFactData,
      entityName,
      sourceMessageLink,
    );

    const buttons = [
      [
        { text: '‚úÖ –ù–æ–≤—ã–π', callback_data: `fact_new:${shortId}` },
        { text: '‚ùå –°—Ç–∞—Ä—ã–π', callback_data: `fact_old:${shortId}` },
        { text: 'üîÄ –û–±–∞', callback_data: `fact_both:${shortId}` },
      ],
    ];

    await this.telegramNotifier.sendWithButtons(message, buttons, 'HTML');
    return shortId;
  }

  async resolveConflict(
    shortId: string,
    resolution: 'new' | 'old' | 'both',
  ): Promise<void> {
    const [existingFactId, newFactDataJson] = await this.digestActionStore.get(shortId);
    const newFactData = JSON.parse(newFactDataJson) as CreateFactDto;

    switch (resolution) {
      case 'new':
        // Deprecate existing, create new as preferred
        await this.factRepo.update(existingFactId, {
          rank: 'deprecated',
          validUntil: new Date(),
        });
        // Create new fact...
        break;
      case 'old':
        // Just increase confidence of existing
        await this.factRepo.increment({ id: existingFactId }, 'confirmationCount', 1);
        break;
      case 'both':
        // Create new fact with coexist marker
        // Keep existing as is
        break;
    }
  }
}
```

**Acceptance:**
- [x] Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ CONFLICT (logic works, tested with adapter offline)
- [ ] –ö–Ω–æ–ø–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (requires telegram-adapter running)
- [ ] –§–∞–∫—Ç—ã –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è —Å–æ–≥–ª–∞—Å–Ω–æ –≤—ã–±–æ—Ä—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

---

### Phase 5: API Endpoints

**–§–∞–π–ª—ã:**
- `apps/pkg-core/src/modules/entity/entity-fact/entity-fact.controller.ts` (NEW or MODIFY)

**Endpoints:**
```typescript
// GET /entities/:entityId/facts?includeDeprecated=false
// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ñ–∞–∫—Ç—ã —Å —É—á—ë—Ç–æ–º rank (preferred first)

// GET /facts/conflicts
// –°–ø–∏—Å–æ–∫ —Ñ–∞–∫—Ç–æ–≤ —Å needsReview=true

// POST /facts/:factId/resolve
// Body: { resolution: 'prefer' | 'deprecate' | 'coexist' }

// POST /facts/conflict-callback/:shortId
// Body: { resolution: 'new' | 'old' | 'both' }
// –î–ª—è Telegram callback
```

**Acceptance:**
- [x] Endpoint –¥–ª—è —Å–ø–∏—Å–∫–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ (GET /facts/conflicts)
- [x] Endpoint –¥–ª—è callback –æ—Ç Telegram (POST /facts/conflict-callback/:shortId)
- [x] –§–∞–∫—Ç—ã —Å–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –ø–æ rank

---

## –§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è

| –§–∞–π–ª | –î–µ–π—Å—Ç–≤–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|----------|----------|
| `packages/entities/src/entity-fact.entity.ts` | MODIFY | Add rank, supersededBy, needsReview, confirmationCount |
| `apps/pkg-core/src/database/migrations/XXXXXX-AddFactFusionFields.ts` | NEW | Migration |
| `apps/pkg-core/src/modules/entity/entity-fact/fact-fusion.service.ts` | NEW | LLM decision service |
| `apps/pkg-core/src/modules/entity/entity-fact/fact-fusion.constants.ts` | NEW | Schema, prompts |
| `apps/pkg-core/src/modules/entity/entity-fact/entity-fact.service.ts` | MODIFY | Integrate fusion |
| `apps/pkg-core/src/modules/notification/fact-conflict.service.ts` | NEW | Telegram notifications |
| `apps/pkg-core/src/modules/entity/entity.module.ts` | MODIFY | Register new services |
| `apps/telegram-adapter/src/bot/handlers/fact-callback.handler.ts` | NEW | Handle callbacks |

---

## Verification

```bash
# 1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
pnpm migration:run

# 2. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã
pnpm test -- fact-fusion

# 3. Manual test: ENRICH case
curl -X POST localhost:3000/api/entities/{entityId}/facts \
  -H "Content-Type: application/json" \
  -d '{"type": "position", "value": "–í–µ–¥—É—â–∏–π —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –≤ –°–±–µ—Ä–±–∞–Ω–∫–µ"}'
# –ü–æ—Å–ª–µ: "–í –°–±–µ—Ä–µ" –¥–æ–ª–∂–µ–Ω —Å—Ç–∞—Ç—å "–í–µ–¥—É—â–∏–π —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –≤ –°–±–µ—Ä–±–∞–Ω–∫–µ"

# 4. Manual test: CONFLICT case
# –î–æ–±–∞–≤–∏—Ç—å "–†–∞–±–æ—Ç–∞–µ—Ç –≤ –¢–∏–Ω—å–∫–æ—Ñ—Ñ" –∫–æ–≥–¥–∞ –µ—Å—Ç—å "–†–∞–±–æ—Ç–∞–µ—Ç –≤ –°–±–µ—Ä–µ"
# ‚Üí –î–æ–ª–∂–Ω–æ –ø—Ä–∏–π—Ç–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram

# 5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Telegram callbacks
# –ù–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É ‚Üí —Ñ–∞–∫—Ç –¥–æ–ª–∂–µ–Ω –æ–±–Ω–æ–≤–∏—Ç—å—Å—è
```

---

## –†–∏—Å–∫–∏ –∏ –º–∏—Ç–∏–≥–∞—Ü–∏—è

| –†–∏—Å–∫ | –ú–∏—Ç–∏–≥–∞—Ü–∏—è |
|------|-----------|
| LLM –æ—à–∏–±–∞–µ—Ç—Å—è –≤ —Ä–µ—à–µ–Ω–∏—è—Ö | –ù–∏–∑–∫–∏–π confidence ‚Üí CONFLICT (user review) |
| Latency LLM calls | Haiku model (fast), async processing |
| –ú–Ω–æ–≥–æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ | Batch digest –≤–º–µ—Å—Ç–æ instant notifications |
| Backward compatibility | skipFusion option, graceful fallback |

---

## –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞

- [x] 90%+ —Ä–µ—à–µ–Ω–∏–π LLM –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã (–ø–æ —Ä—É—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–µ) ‚Äî CONFIRM/CONFLICT —Ä–∞–±–æ—Ç–∞—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- [x] < 5% —Ñ–∞–∫—Ç–æ–≤ —Ç—Ä–µ–±—É—é—Ç user review (CONFLICT) ‚Äî —Ç–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω—ã–µ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è
- [ ] ENRICH —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –æ–±–æ–∏—Ö —Ñ–∞–∫—Ç–æ–≤ (not tested yet)
- [x] –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ < 3s (–≤–∫–ª—é—á–∞—è LLM call) ‚Äî ~1-2s —Å Haiku

---

# Phase 6: Context-Aware Extraction (–û–±—Å—É–∂–¥–µ–Ω–∏–µ)

> **–°—Ç–∞—Ç—É—Å:** –ü—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
> **–î–∞—Ç–∞:** 2025-01-24

## –ö–æ–Ω—Ü–µ–ø—Ü–∏—è

–§–∞–∫—Ç—ã —Å—É—â–Ω–æ—Å—Ç–∏ = –µ—ë "–ø–∞–º—è—Ç—å". –ü—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö —Ñ–∞–∫—Ç–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ–∞–∫—Ç—ã –∫–∞–∫ –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –ª—É—á—à–µ–≥–æ –ø–æ–Ω–∏–º–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π.

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    CONTEXT-AWARE EXTRACTION                      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                  ‚îÇ
‚îÇ  Entity Facts ‚îÄ‚îÄ‚ñ∫ formatAsContext() ‚îÄ‚îÄ‚ñ∫ Compact Context         ‚îÇ
‚îÇ       ‚ñ≤                                       ‚îÇ                  ‚îÇ
‚îÇ       ‚îÇ                                       ‚ñº                  ‚îÇ
‚îÇ       ‚îÇ                              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê          ‚îÇ
‚îÇ       ‚îÇ                              ‚îÇ  New Message   ‚îÇ          ‚îÇ
‚îÇ       ‚îÇ                              ‚îÇ + Entity Context‚îÇ         ‚îÇ
‚îÇ       ‚îÇ                              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò          ‚îÇ
‚îÇ       ‚îÇ                                      ‚ñº                   ‚îÇ
‚îÇ       ‚îÇ                              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê          ‚îÇ
‚îÇ       ‚îÇ                              ‚îÇ  LLM Extract   ‚îÇ          ‚îÇ
‚îÇ       ‚îÇ                              ‚îÇ (context-aware)‚îÇ          ‚îÇ
‚îÇ       ‚îÇ                              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò          ‚îÇ
‚îÇ       ‚îÇ                                      ‚îÇ                   ‚îÇ
‚îÇ       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                   ‚îÇ
‚îÇ                    New/Updated Facts                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## –ü—Ä–æ–±–ª–µ–º—ã —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–¥—Ö–æ–¥–∞

| –ü—Ä–æ–±–ª–µ–º–∞ | –ü—Ä–∏–º–µ—Ä | –¢–µ–∫—É—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç | –° –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º |
|----------|--------|-------------------|--------------|
| **–¢—Ä–µ—Ç—å–∏ –ª–∏—Ü–∞** | "–ú–∞—à–∞ —É–∂–µ –≤ –°–±–µ—Ä–µ —Ä–∞–±–æ—Ç–∞–µ—Ç" | –§–∞–∫—Ç –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –ò–≤–∞–Ω—É ‚ùå | –ó–Ω–∞–µ—Ç —á—Ç–æ –ú–∞—à–∞ = –∂–µ–Ω–∞ –ò–≤–∞–Ω–∞ ‚úÖ |
| **–ú–µ—Å—Ç–æ–∏–º–µ–Ω–∏—è** | "–û–Ω–∞ –ø–µ—Ä–µ–¥–∞—ë—Ç –ø—Ä–∏–≤–µ—Ç" | –ù–µ –∏–∑–≤–ª–µ–∫–∞–µ—Ç (–∫—Ç–æ "–æ–Ω–∞"?) | –°–≤—è–∑—å: –∂–µ–Ω–∞ –ú–∞—Ä–∏—è ‚Üí –ø–æ–Ω–∏–º–∞–µ—Ç ‚úÖ |
| **–°–º–µ–Ω–∞ —Ä–∞–±–æ—Ç—ã** | "–Ø —Ç–µ–ø–µ—Ä—å –≤ –¢–∏–Ω—å–∫–æ—Ñ—Ñ" (–±—ã–ª–æ –°–±–µ—Ä) | –°–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–π ‚Üí Fusion —Ä–µ—à–∞–µ—Ç | –°—Ä–∞–∑—É –≤–∏–¥–∏—Ç –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–µ ‚Üí SUPERSEDE |
| **–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ** | "–î–† —á–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é" (8 –º–∞—Ä—Ç–∞, –∫–æ–Ω—Ç–µ–∫—Å—Ç: –î–† 15 –º–∞—Ä—Ç–∞) | –ò–∑–≤–ª–µ–∫–∞–µ—Ç –∫–∞–∫ –Ω–æ–≤—ã–π —Ñ–∞–∫—Ç | –ü–æ–Ω–∏–º–∞–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ ‚Üí CONFIRM —Å –≤—ã—Å–æ–∫–∏–º confidence |

---

## –ö–æ–º–ø–æ–Ω–µ–Ω—Ç 1: –°–≤—è–∑–∏ –º–µ–∂–¥—É —Å—É—â–Ω–æ—Å—Ç—è–º–∏ (EntityRelation)

### –ü—Ä–æ–±–ª–µ–º–∞

–°–µ–π—á–∞—Å —Å–≤—è–∑–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –Ω–µ—è–≤–Ω–æ (—Ñ–∞–∫—Ç—ã —Ç–∏–ø–∞ `company`) –∏–ª–∏ –≤ `EntityRelationshipProfile`. –ù–µ—Ç —è–≤–Ω–æ–π –º–æ–¥–µ–ª–∏ "–ò–≤–∞–Ω ‚Üí –∂–µ–Ω–∞ ‚Üí –ú–∞—Ä–∏—è".

### –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º–∞—è –º–æ–¥–µ–ª—å

```typescript
// packages/entities/src/entity-relation.entity.ts

@Entity('entity_relations')
export class EntityRelation {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column({ name: 'source_entity_id', type: 'uuid' })
  @Index()
  sourceEntityId: string;  // –ò–≤–∞–Ω

  @ManyToOne(() => EntityRecord, { onDelete: 'CASCADE' })
  @JoinColumn({ name: 'source_entity_id' })
  sourceEntity: EntityRecord;

  @Column({ name: 'target_entity_id', type: 'uuid' })
  @Index()
  targetEntityId: string;  // –ú–∞—Ä–∏—è

  @ManyToOne(() => EntityRecord, { onDelete: 'CASCADE' })
  @JoinColumn({ name: 'target_entity_id' })
  targetEntity: EntityRecord;

  @Column({ name: 'relation_type', length: 50 })
  relationType: RelationType;

  @Column({ name: 'relation_label', length: 100, nullable: true })
  relationLabel: string | null;  // "–∂–µ–Ω–∞", "–ú–∞—à–∞", "—à–µ—Ñ"

  @Column({ type: 'boolean', default: true })
  bidirectional: boolean;  // –ï—Å–ª–∏ true, —Å–æ–∑–¥–∞—ë—Ç—Å—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å

  @Column({ type: 'jsonb', nullable: true })
  metadata: Record<string, unknown> | null;  // { since: '2015' }

  @Column({ name: 'source', length: 20, default: 'extracted' })
  source: 'manual' | 'extracted' | 'imported';

  @Column({ type: 'decimal', precision: 3, scale: 2, nullable: true })
  confidence: number | null;

  @CreateDateColumn({ name: 'created_at' })
  createdAt: Date;
}

enum RelationType {
  // –°–µ–º—å—è
  SPOUSE = 'spouse',           // –º—É–∂/–∂–µ–Ω–∞
  CHILD = 'child',             // —Ä–µ–±—ë–Ω–æ–∫
  PARENT = 'parent',           // —Ä–æ–¥–∏—Ç–µ–ª—å
  SIBLING = 'sibling',         // –±—Ä–∞—Ç/—Å–µ—Å—Ç—Ä–∞
  RELATIVE = 'relative',       // –¥—Ä—É–≥–æ–π —Ä–æ–¥—Å—Ç–≤–µ–Ω–Ω–∏–∫

  // –†–∞–±–æ—Ç–∞
  COLLEAGUE = 'colleague',     // –∫–æ–ª–ª–µ–≥–∞
  MANAGER = 'manager',         // —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å
  SUBORDINATE = 'subordinate', // –ø–æ–¥—á–∏–Ω—ë–Ω–Ω—ã–π
  BUSINESS_PARTNER = 'business_partner',

  // –°–æ—Ü–∏–∞–ª—å–Ω—ã–µ
  FRIEND = 'friend',
  ACQUAINTANCE = 'acquaintance',

  // –°–ª—É–∂–µ–±–Ω—ã–µ
  ASSISTANT = 'assistant',     // –ø–æ–º–æ—â–Ω–∏–∫/—Å–µ–∫—Ä–µ—Ç–∞—Ä—å
  MENTOR = 'mentor',
}
```

### –ö–∞–∫ —Å–≤—è–∑–∏ –ø–æ–ø–∞–¥–∞—é—Ç –≤ —Å–∏—Å—Ç–µ–º—É

```
–°–æ–æ–±—â–µ–Ω–∏–µ: "–ú–∞—à–∞ (–º–æ—è –∂–µ–Ω–∞) –ø–µ—Ä–µ–¥–∞—ë—Ç –ø—Ä–∏–≤–µ—Ç"
                    ‚îÇ
                    ‚ñº
           LLM Extraction
                    ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚ñº                       ‚ñº
   –§–∞–∫—Ç: –Ω–µ—Ç               –°–≤—è–∑—å: spouse
   (—ç—Ç–æ –Ω–µ —Ñ–∞–∫—Ç –æ–± –ò–≤–∞–Ω–µ)  sourceEntityId: –ò–≤–∞–Ω
                           targetEntityId: –Ω–∞–π—Ç–∏/—Å–æ–∑–¥–∞—Ç—å "–ú–∞—Ä–∏—è"
                           relationLabel: "–∂–µ–Ω–∞", "–ú–∞—à–∞"
```

### –ú–∏–≥—Ä–∞—Ü–∏—è

```sql
CREATE TYPE relation_type AS ENUM (
  'spouse', 'child', 'parent', 'sibling', 'relative',
  'colleague', 'manager', 'subordinate', 'business_partner',
  'friend', 'acquaintance', 'assistant', 'mentor'
);

CREATE TABLE entity_relations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  source_entity_id UUID NOT NULL REFERENCES entities(id) ON DELETE CASCADE,
  target_entity_id UUID NOT NULL REFERENCES entities(id) ON DELETE CASCADE,
  relation_type relation_type NOT NULL,
  relation_label VARCHAR(100),
  bidirectional BOOLEAN DEFAULT TRUE,
  metadata JSONB,
  source VARCHAR(20) DEFAULT 'extracted',
  confidence DECIMAL(3,2),
  created_at TIMESTAMP DEFAULT NOW(),

  UNIQUE(source_entity_id, target_entity_id, relation_type)
);

CREATE INDEX idx_entity_relations_source ON entity_relations(source_entity_id);
CREATE INDEX idx_entity_relations_target ON entity_relations(target_entity_id);
```

---

## –ö–æ–º–ø–æ–Ω–µ–Ω—Ç 2: Subject Resolution –≤ –≥—Ä—É–ø–ø–æ–≤—ã—Ö —á–∞—Ç–∞—Ö

### –ü—Ä–æ–±–ª–µ–º–∞

```
–ì—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç "–ö–æ–º–∞–Ω–¥–∞":
‚îú‚îÄ‚îÄ –ò–≤–∞–Ω: "–ó–∞–≤—Ç—Ä–∞ —É –ü–µ—Ç–∏ –î–†"
‚îú‚îÄ‚îÄ –ü–µ—Ç—è: "–î–∞, 35 –ª–µ—Ç —É–∂–µ"
‚îî‚îÄ‚îÄ –ú–∞—à–∞: "–ü–µ—Ç—å, –ø–æ–∑–¥—Ä–∞–≤–ª—è—é! –ö–∞–∫ –¥–µ–ª–∞ –Ω–∞ –Ω–æ–≤–æ–π —Ä–∞–±–æ—Ç–µ?"
```

–ö–æ–º—É –∫–∞–∫–∏–µ —Ñ–∞–∫—Ç—ã?

### –ê–ª–≥–æ—Ä–∏—Ç–º –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å—É–±—ä–µ–∫—Ç–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              SUBJECT RESOLUTION ALGORITHM                    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                              ‚îÇ
‚îÇ  1. EXPLICIT MENTION (highest priority)                      ‚îÇ
‚îÇ     "–£ –ü–µ—Ç–∏ –î–†" ‚Üí —Å—É–±—ä–µ–∫—Ç = –ü–µ—Ç—è                            ‚îÇ
‚îÇ     –ü–∞—Ç—Ç–µ—Ä–Ω—ã: "—É X", "X —Å–∫–∞–∑–∞–ª", –∏–º—è –≤ —Ä–æ–¥. –ø–∞–¥–µ–∂–µ          ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ  2. DIRECT ADDRESS                                           ‚îÇ
‚îÇ     "–ü–µ—Ç—å, –ø–æ–∑–¥—Ä–∞–≤–ª—è—é" ‚Üí —Å—É–±—ä–µ–∫—Ç = –ü–µ—Ç—è                     ‚îÇ
‚îÇ     –ü–∞—Ç—Ç–µ—Ä–Ω—ã: –æ–±—Ä–∞—â–µ–Ω–∏–µ, @mention, –∑–≤–∞—Ç–µ–ª—å–Ω—ã–π –ø–∞–¥–µ–∂         ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ  3. REPLY CONTEXT                                            ‚îÇ
‚îÇ     –ú–∞—à–∞ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –ü–µ—Ç–∏ ‚Üí —Å—É–±—ä–µ–∫—Ç = –ü–µ—Ç—è        ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ  4. SELF-REFERENCE                                           ‚îÇ
‚îÇ     "–Ø —Ç–µ–ø–µ—Ä—å –¥–∏—Ä–µ–∫—Ç–æ—Ä" ‚Üí —Å—É–±—ä–µ–∫—Ç = –∞–≤—Ç–æ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è         ‚îÇ
‚îÇ     –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞: "—è", "–º–æ–π", "–º–µ–Ω—è", "—É –º–µ–Ω—è"            ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ  5. THREAD CONTEXT                                           ‚îÇ
‚îÇ     –ï—Å–ª–∏ –≤ —Ç—Ä–µ–¥–µ –æ–±—Å—É–∂–¥–∞—é—Ç –ü–µ—Ç—é ‚Üí —Å—É–±—ä–µ–∫—Ç = –ü–µ—Ç—è            ‚îÇ
‚îÇ     (–∞–Ω–∞–ª–∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö N —Å–æ–æ–±—â–µ–Ω–∏–π)                         ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ  6. DEFAULT (lowest priority)                                ‚îÇ
‚îÇ     –õ–∏—á–Ω—ã–π —á–∞—Ç ‚Üí —Å—É–±—ä–µ–∫—Ç = —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫                       ‚îÇ
‚îÇ     –ì—Ä—É–ø–ø–∞ –±–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ ‚Üí –ù–ï –∏–∑–≤–ª–µ–∫–∞—Ç—å (low confidence)    ‚îÇ
‚îÇ                                                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –§–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä—É–ø–ø–æ–≤–æ–≥–æ extraction

```typescript
interface GroupExtractionContext {
  chatType: 'private' | 'group' | 'supergroup' | 'channel';

  // –£—á–∞—Å—Ç–Ω–∏–∫–∏ —Å –∏—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º (—Ñ–∞–∫—Ç—ã + —Å–≤—è–∑–∏)
  participants: Array<{
    entityId: string;
    name: string;
    aliases: string[];           // ["–ü–µ—Ç—è", "–ü—ë—Ç—Ä", "–ü–µ—Ç—Ä—É—Ö–∞", "@petr"]
    factsSummary: string;        // –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ñ–∞–∫—Ç–æ–≤
    relations: string[];         // ["–∫–æ–ª–ª–µ–≥–∞ –ò–≤–∞–Ω–∞", "–º—É–∂ –ú–∞—à–∏"]
  }>;

  // –°–æ–æ–±—â–µ–Ω–∏—è —Å –∞–≤—Ç–æ—Ä—Å—Ç–≤–æ–º
  messages: Array<{
    authorEntityId: string;
    authorName: string;
    content: string;
    replyToAuthorId?: string;
    replyToContent?: string;     // –î–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ reply
    timestamp: Date;
  }>;
}
```

### Prompt –¥–ª—è –≥—Ä—É–ø–ø—ã

```
–ò–∑–≤–ª–µ–∫–∏ —Ñ–∞–∫—Ç—ã –∏–∑ –≥—Ä—É–ø–ø–æ–≤–æ–≥–æ —á–∞—Ç–∞.
–í–ê–ñ–ù–û: –û–ø—Ä–µ–¥–µ–ª–∏ –ö–û–ú–£ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –∫–∞–∂–¥—ã–π —Ñ–∞–∫—Ç.

–£–ß–ê–°–¢–ù–ò–ö–ò:
1. –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤ (ID: xxx)
   ‚Ä¢ –§–∞–∫—Ç—ã: CTO –≤ –°–±–µ—Ä–±–∞–Ω–∫–µ
   ‚Ä¢ –°–≤—è–∑–∏: –∫–æ–ª–ª–µ–≥–∞ –ü–µ—Ç–∏, –∑–Ω–∞–µ—Ç –ú–∞—à—É

2. –ü–µ—Ç—è –°–∏–¥–æ—Ä–æ–≤ (ID: yyy)
   ‚Ä¢ –§–∞–∫—Ç—ã: Backend —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫
   ‚Ä¢ –î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è: –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω

3. –ú–∞—à–∞ –ö–æ–∑–ª–æ–≤–∞ (ID: zzz)
   ‚Ä¢ –§–∞–∫—Ç—ã: HR –¥–∏—Ä–µ–∫—Ç–æ—Ä
   ‚Ä¢ –°–≤—è–∑–∏: –∫–æ–ª–ª–µ–≥–∞ –ü–µ—Ç–∏

–ü–ï–†–ï–ü–ò–°–ö–ê:
[–ò–≤–∞–Ω]: –ó–∞–≤—Ç—Ä–∞ —É –ü–µ—Ç–∏ –î–†
[–ü–µ—Ç—è]: –î–∞, 35 –ª–µ—Ç —É–∂–µ
[–ú–∞—à–∞ ‚Üí reply to –ü–µ—Ç—è]: –ü–µ—Ç—å, –ø–æ–∑–¥—Ä–∞–≤–ª—è—é! –ö–∞–∫ –¥–µ–ª–∞ –Ω–∞ –Ω–æ–≤–æ–π —Ä–∞–±–æ—Ç–µ?

–ó–ê–î–ê–ß–ê: –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–∫—Ç–∞ —É–∫–∞–∂–∏:
- subjectEntityId: UUID —Å—É—â–Ω–æ—Å—Ç–∏, –∫–æ—Ç–æ—Ä–æ–π –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç —Ñ–∞–∫—Ç
- factType, value, confidence
- reasoning: –ø–æ—á–µ–º—É —Ñ–∞–∫—Ç –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ —ç—Ç–æ–º—É —á–µ–ª–æ–≤–µ–∫—É
```

---

## –ö–æ–º–ø–æ–Ω–µ–Ω—Ç 3: Batch Processing –ø–æ –ª–æ–≥–∏—á–µ—Å–∫–∏–º –≥—Ä–∞–Ω–∏—Ü–∞–º

### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

Extraction –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø–æ —Å–µ—Å—Å–∏—è–º (gap > 4 —á–∞—Å–∞). –ù–æ –≤–Ω—É—Ç—Ä–∏ —Å–µ—Å—Å–∏–∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –º–Ω–æ–≥–æ —Ä–∞–∑–Ω—ã—Ö —Ç–µ–º.

### –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º—ã–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              EXTRACTION TRIGGERS                             ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                              ‚îÇ
‚îÇ  TRIGGER 1: SESSION END (—Ç–µ–∫—É—â–∏–π)                           ‚îÇ
‚îÇ  Gap > 4 —á–∞—Å–∞ ‚Üí –Ω–æ–≤–∞—è —Å–µ—Å—Å–∏—è ‚Üí extraction                   ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ  TRIGGER 2: TOPIC SHIFT (–Ω–æ–≤—ã–π)                             ‚îÇ
‚îÇ  –í–Ω—É—Ç—Ä–∏ —Å–µ—Å—Å–∏–∏ –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å —Å–º–µ–Ω—É —Ç–µ–º—ã:                       ‚îÇ
‚îÇ  - –Ø–≤–Ω–∞—è: "–ö—Å—Ç–∞—Ç–∏, –æ –¥—Ä—É–≥–æ–º...", "–ê –≤–æ—Ç –µ—â—ë..."            ‚îÇ
‚îÇ  - –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∞—è: cosine distance > 0.7 –º–µ–∂–¥—É –±–ª–æ–∫–∞–º–∏      ‚îÇ
‚îÇ  - –í—Ä–µ–º–µ–Ω–Ω–∞—è: –ø–∞—É–∑–∞ > 30 –º–∏–Ω –≤–Ω—É—Ç—Ä–∏ —Å–µ—Å—Å–∏–∏                  ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ  TRIGGER 3: BUFFER FULL (fallback)                          ‚îÇ
‚îÇ  –ö–∞–∂–¥—ã–µ N —Å–æ–æ–±—â–µ–Ω–∏–π (15-20) –µ—Å–ª–∏ –Ω–µ—Ç –¥—Ä—É–≥–∏—Ö —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤       ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ  TRIGGER 4: EXPLICIT (manual)                               ‚îÇ
‚îÇ  –ö–æ–º–∞–Ω–¥–∞ /extract –∏–ª–∏ API –≤—ã–∑–æ–≤                             ‚îÇ
‚îÇ                                                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π flow

```
Messages Stream
      ‚îÇ
      ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Buffer    ‚îÇ ‚Üê –ù–∞–∫–∞–ø–ª–∏–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è (–≤ –ø–∞–º—è—Ç–∏/Redis)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Trigger Detection     ‚îÇ
‚îÇ   ‚Ä¢ Session end?        ‚îÇ
‚îÇ   ‚Ä¢ Topic shift?        ‚îÇ
‚îÇ   ‚Ä¢ Buffer full (20)?   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
            ‚îÇ trigger!
            ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Load Entity Contexts  ‚îÇ ‚Üê –§–∞–∫—Ç—ã + —Å–≤—è–∑–∏ –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
            ‚îÇ
            ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Batch Extraction      ‚îÇ ‚Üê –û–î–ò–ù LLM –≤—ã–∑–æ–≤ –Ω–∞ –≤–µ—Å—å batch
‚îÇ   ‚Ä¢ Subject resolution  ‚îÇ
‚îÇ   ‚Ä¢ Fact extraction     ‚îÇ
‚îÇ   ‚Ä¢ Relation extraction ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
            ‚îÇ
            ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Distribution          ‚îÇ
‚îÇ   ‚Ä¢ Route facts ‚Üí entities ‚îÇ
‚îÇ   ‚Ä¢ Fusion per entity   ‚îÇ
‚îÇ   ‚Ä¢ Create relations    ‚îÇ
‚îÇ   ‚Ä¢ Update contexts     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## –ö–æ–º–ø–æ–Ω–µ–Ω—Ç 4: –§–∞–∫—Ç—ã –∫–∞–∫ –∫–æ–Ω—Ç–µ–∫—Å—Ç (Entity Memory)

### –£–∂–µ –µ—Å—Ç—å

```typescript
// EntityFact —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å—ë –Ω—É–∂–Ω–æ–µ
interface EntityFact {
  entityId: string;
  factType: string;        // position, company, birthday...
  value: string;
  confidence: number;
  rank: 'preferred' | 'normal' | 'deprecated';
  confirmationCount: number;
}
```

### –ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å

```typescript
// EntityFactService - –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥
async getContextString(entityId: string, options?: {
  maxFacts?: number;        // –õ–∏–º–∏—Ç —Ñ–∞–∫—Ç–æ–≤ (default: 10)
  includeRelations?: boolean; // –í–∫–ª—é—á–∏—Ç—å —Å–≤—è–∑–∏
  maxTokens?: number;       // –õ–∏–º–∏—Ç —Ç–æ–∫–µ–Ω–æ–≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
}): Promise<string> {
  const facts = await this.findByEntityWithRanking(entityId, {
    includeDeprecated: false,
    limit: options?.maxFacts || 10,
  });

  const relations = options?.includeRelations
    ? await this.relationService.findByEntity(entityId)
    : [];

  return this.formatAsContext(facts, relations);
}

private formatAsContext(facts: EntityFact[], relations: EntityRelation[]): string {
  let context = '';

  // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Ñ–∞–∫—Ç—ã –ø–æ —Ç–∏–ø–∞–º
  const byType = groupBy(facts.filter(f => f.rank !== 'deprecated'), 'factType');

  if (byType.position?.[0]) context += `‚Ä¢ –î–æ–ª–∂–Ω–æ—Å—Ç—å: ${byType.position[0].value}\n`;
  if (byType.company?.[0]) context += `‚Ä¢ –ö–æ–º–ø–∞–Ω–∏—è: ${byType.company[0].value}\n`;
  if (byType.birthday?.[0]) context += `‚Ä¢ –î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è: ${byType.birthday[0].value}\n`;
  if (byType.phone?.[0]) context += `‚Ä¢ –¢–µ–ª–µ—Ñ–æ–Ω: ${byType.phone[0].value}\n`;
  // ... other types

  // –°–≤—è–∑–∏
  if (relations.length > 0) {
    context += '\n–°–≤—è–∑–∏:\n';
    for (const rel of relations.slice(0, 5)) {
      const label = rel.relationLabel || RELATION_TYPE_LABELS[rel.relationType];
      context += `‚Ä¢ ${label}: ${rel.targetEntity?.name || rel.targetEntityId}\n`;
    }
  }

  return context;
}
```

### –§–æ—Ä–º–∞—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è prompt

```
–ö–æ–Ω—Ç–µ–∫—Å—Ç: –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìã –§–∞–∫—Ç—ã:
‚Ä¢ –î–æ–ª–∂–Ω–æ—Å—Ç—å: CTO
‚Ä¢ –ö–æ–º–ø–∞–Ω–∏—è: –°–±–µ—Ä–±–∞–Ω–∫ (—Å 2020)
‚Ä¢ –î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è: 15 –º–∞—Ä—Ç–∞ 1985
‚Ä¢ Telegram: @ivan_petrov

üë• –°–≤—è–∑–∏:
‚Ä¢ –ñ–µ–Ω–∞: –ú–∞—Ä–∏—è (–ú–∞—à–∞)
‚Ä¢ –ö–æ–ª–ª–µ–≥–∞: –ü–µ—Ç—è –°–∏–¥–æ—Ä–æ–≤
‚Ä¢ –†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å: –ì–µ—Ä–º–∞–Ω –ì—Ä–µ—Ñ
```

---

## –í–æ–ø—Ä–æ—Å—ã –¥–ª—è —Ä–µ—à–µ–Ω–∏—è

### Q1: –ì–¥–µ —Ö—Ä–∞–Ω–∏—Ç—å —Å–≤—è–∑–∏?

**–í–∞—Ä–∏–∞–Ω—Ç A: –°–≤—è–∑–∏ –∫–∞–∫ —Ñ–∞–∫—Ç—ã**
```typescript
// factType: 'relation_spouse', value: '–ú–∞—Ä–∏—è', valueJson: { targetEntityId: '...' }
```
‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É
‚ùå –ù–µ—Ç bidirectional, —Å–ª–æ–∂–Ω–µ–µ –≥—Ä–∞—Ñ

**–í–∞—Ä–∏–∞–Ω—Ç B: –û—Ç–¥–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ EntityRelation** ‚Üê –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è
```typescript
// entity_relations: source_id, target_id, relation_type, label
```
‚úÖ –ß–∏—Å—Ç–∞—è –º–æ–¥–µ–ª—å –≥—Ä–∞—Ñ–∞
‚úÖ –õ–µ–≥–∫–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å "–≤—Å–µ —Å–≤—è–∑–∏ –ò–≤–∞–Ω–∞"
‚ùå –ù–æ–≤–∞—è entity, –º–∏–≥—Ä–∞—Ü–∏—è, —Å–µ—Ä–≤–∏—Å

### Q2: –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞?

**–í–∞—Ä–∏–∞–Ω—Ç A: –ë–µ–∑ –∫—ç—à–∞** ‚Äî —Å—Ç—Ä–æ–∏—Ç—å –Ω–∞ –∫–∞–∂–¥—ã–π extraction
- ‚úÖ –í—Å–µ–≥–¥–∞ –∞–∫—Ç—É–∞–ª—å–Ω—ã–π
- ‚ùå –õ–∏—à–Ω–∏–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î

**–í–∞—Ä–∏–∞–Ω—Ç B: Redis —Å TTL** ‚Üê –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è
- ‚úÖ –ë—ã—Å—Ç—Ä–æ
- ‚ö†Ô∏è –ù—É–∂–Ω–æ –∏–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ñ–∞–∫—Ç–æ–≤

**–í–∞—Ä–∏–∞–Ω—Ç C: –ü–æ–ª–µ –≤ Entity**
- ‚úÖ –í—Å–µ–≥–¥–∞ –ø–æ–¥ —Ä—É–∫–æ–π
- ‚ùå –ù—É–∂–Ω–æ –æ–±–Ω–æ–≤–ª—è—Ç—å –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ñ–∞–∫—Ç–∞

### Q3: –ö–∞–∫ –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å Topic Shift?

**–í–∞—Ä–∏–∞–Ω—Ç A: –¢–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–π gap (30 –º–∏–Ω)**
- ‚úÖ –ü—Ä–æ—Å—Ç–æ
- ‚ùå –ú–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Ç–æ—á–Ω–æ

**–í–∞—Ä–∏–∞–Ω—Ç B: Semantic similarity –º–µ–∂–¥—É –±–ª–æ–∫–∞–º–∏**
- ‚úÖ –¢–æ—á–Ω–µ–µ
- ‚ùå –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ embedding –≤—ã—á–∏—Å–ª–µ–Ω–∏—è

**–í–∞—Ä–∏–∞–Ω—Ç C: –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞** ("–∫—Å—Ç–∞—Ç–∏", "–∞ –≤–æ—Ç", "–¥—Ä—É–≥–æ–π –≤–æ–ø—Ä–æ—Å")
- ‚úÖ –ü—Ä–æ—Å—Ç–æ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚ùå –ù–µ –≤—Å–µ —Å–º–µ–Ω—ã —Ç–µ–º—ã —è–≤–Ω—ã–µ

---

## –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

| # | –ó–∞–¥–∞—á–∞ | –°–ª–æ–∂–Ω–æ—Å—Ç—å | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç |
|---|--------|-----------|-----------|
| 1 | `getContextString()` –≤ EntityFactService | Low | **High** |
| 2 | –ü–µ—Ä–µ–¥–∞—á–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤ extraction prompt | Low | **High** |
| 3 | `EntityRelation` entity + migration | Medium | **High** |
| 4 | `EntityRelationService` CRUD | Medium | High |
| 5 | Extraction —Å–≤—è–∑–µ–π –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏–π | High | Medium |
| 6 | Subject resolution –¥–ª—è –≥—Ä—É–ø–ø | High | Medium |
| 7 | Topic shift detection | Medium | Low |
| 8 | Redis –∫—ç—à –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ | Low | Low |

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø–æ—Ä—è–¥–æ–∫

**–≠—Ç–∞–ø 1 (Quick Win):** –ó–∞–¥–∞—á–∏ 1-2
- –î–æ–±–∞–≤–∏—Ç—å `getContextString()`
- –ü–µ—Ä–µ–¥–∞–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤ extraction
- –£–∂–µ —É–ª—É—á—à–∏—Ç –∫–∞—á–µ—Å—Ç–≤–æ extraction

**–≠—Ç–∞–ø 2 (Relations):** –ó–∞–¥–∞—á–∏ 3-5
- EntityRelation –º–æ–¥–µ–ª—å
- –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å–≤—è–∑–µ–π
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–≤—è–∑–µ–π –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ

**–≠—Ç–∞–ø 3 (Groups):** –ó–∞–¥–∞—á–∞ 6
- Subject resolution –¥–ª—è –≥—Ä—É–ø–ø–æ–≤—ã—Ö —á–∞—Ç–æ–≤

**–≠—Ç–∞–ø 4 (Optimization):** –ó–∞–¥–∞—á–∏ 7-8
- Topic shift detection
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

---

## Acceptance Criteria

- [ ] –ü—Ä–∏ extraction –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∞–∫—Ç–æ–≤
- [ ] "–ú–∞—à–∞ (–∂–µ–Ω–∞) –ø–µ—Ä–µ–¥–∞—ë—Ç –ø—Ä–∏–≤–µ—Ç" –Ω–µ —Å–æ–∑–¥–∞—ë—Ç —Ñ–∞–∫—Ç –¥–ª—è –ò–≤–∞–Ω–∞
- [ ] –°–≤—è–∑–∏ –∏–∑–≤–ª–µ–∫–∞—é—Ç—Å—è –∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ EntityRelation
- [ ] –í –≥—Ä—É–ø–ø–æ–≤—ã—Ö —á–∞—Ç–∞—Ö —Ñ–∞–∫—Ç—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –ø–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º
- [ ] Subject resolution —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è reply –∏ @mentions
